<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .editable {
      background-color: #fffde7;
      cursor: pointer;
    }
    .save-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .grade-select, .status-select, .exam-name-select {
      padding: 4px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    section {
      margin-bottom: 40px;
    }
    header {
      background-color: #eee;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      margin: 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Teacher Dashboard</h1>
    <p>Welcome, <span id="teacherName"></span></p>
    <button onclick="localStorage.clear(); location.href='index.html'">Logout</button>
  </header>
  <main id="dashboard"></main>

  <script>
    const teacherEmail = localStorage.getItem('teacherEmail');
    const allowedClasses = JSON.parse(localStorage.getItem('allowedClasses') || '[]');
    if (!teacherEmail || allowedClasses.length === 0) {
      window.location.href = 'index.html';
    throw new Error("Not authenticated"); // Stop execution
    }

    document.getElementById('teacherName').textContent = teacherEmail;

    const API_URL = "https://script.google.com/macros/s/AKfycbxrc4sNRKyZIUyBY7xu4o8TWKNraIu-4jXEUTSwl7bLJqR6Wq5dWNdhAFt-ZgCbI7zs/exec"; // Replace with your actual deployed Apps Script URL

    function calculateGrade(marks) {
      if (marks >= 90) return 'A+';
      if (marks >= 80) return 'A';
      if (marks >= 70) return 'B';
      if (marks >= 60) return 'C';
      if (marks >= 50) return 'D';
      return 'F';
    }

    function getStatus(marks) {
      if (marks === '' || isNaN(marks)) return 'Pending';
      return marks >= 35 ? 'Pass' : 'Fail';
    }

    async function fetchClassData(className) {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'getClassData', className })
      });
      return await response.json();
    }

    async function updateStudent(className, rollNo, updates) {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'update', className, rollNo, updates })
      });
      return await response.json();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('teacherName').textContent = teacherEmail;
      const container = document.getElementById('dashboard');

      for (const className of allowedClasses) {
        const data = await fetchClassData(className);
        const section = document.createElement('section');
        section.innerHTML = `<h2>${className}</h2>`;

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tr = document.createElement('tr');

        data.headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          tr.appendChild(th);
        });
        tr.innerHTML += '<th>Actions</th>';
        thead.appendChild(tr);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.students.forEach(student => {
          const row = document.createElement('tr');
          data.headers.forEach(header => {
            const td = document.createElement('td');

            if (header === 'Marks') {
              td.innerHTML = `
                <input 
                  type="number" 
                  value="${student[header] || ''}" 
                  class="editable-marks" 
                  data-roll="${student['roll no']}"
                  min="0" max="100"
                >`;
              td.classList.add('editable');
            }
            else if (header === 'Grade') {
              td.innerHTML = `
                <select class="grade-select" data-roll="${student['roll no']}">
                  <option value="A+" ${student[header] === 'A+' ? 'selected' : ''}>A+</option>
                  <option value="A" ${student[header] === 'A' ? 'selected' : ''}>A</option>
                  <option value="B" ${student[header] === 'B' ? 'selected' : ''}>B</option>
                  <option value="C" ${student[header] === 'C' ? 'selected' : ''}>C</option>
                  <option value="D" ${student[header] === 'D' ? 'selected' : ''}>D</option>
                  <option value="F" ${student[header] === 'F' ? 'selected' : ''}>F</option>
                </select>`;
            }
            else if (header === 'Status') {
              td.innerHTML = `
                <select class="status-select" data-roll="${student['roll no']}">
                  <option value="Pass" ${student[header] === 'Pass' ? 'selected' : ''}>Pass</option>
                  <option value="Fail" ${student[header] === 'Fail' ? 'selected' : ''}>Fail</option>
                  <option value="Pending" ${student[header] === 'Pending' ? 'selected' : ''}>Pending</option>
                </select>`;
            }
            else if (header === 'Exam Name') {
              td.innerHTML = `
                <select class="exam-name-select" data-roll="${student['roll no']}">
                  <option value="">-- Select Exam --</option>
                  <option value="First Semester" ${student[header] === 'First Semester' ? 'selected' : ''}>First Semester</option>
                  <option value="Second Semester" ${student[header] === 'Second Semester' ? 'selected' : ''}>Second Semester</option>
                  <option value="First Periodic" ${student[header] === 'First Periodic' ? 'selected' : ''}>First Periodic</option>
                  <option value="Second Periodic" ${student[header] === 'Second Periodic' ? 'selected' : ''}>Second Periodic</option>
                  <option value="Fourth Semester" ${student[header] === 'Fourth Semester' ? 'selected' : ''}>Fourth Semester</option>
                </select>`;
            }
            else {
              td.textContent = student[header] || '-';
            }

            row.appendChild(td);
          });

          const actionTd = document.createElement('td');
          actionTd.innerHTML = `
            <button class="save-btn" 
              onclick="saveChanges('${className}', '${student['roll no']}')">
              Save
            </button>`;
          row.appendChild(actionTd);
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        section.appendChild(table);
        container.appendChild(section);
      }
    });

    async function saveChanges(className, rollNo) {
      const row = document.querySelector(`[data-roll="${rollNo}"]`).closest('tr');
      const marks = parseFloat(row.querySelector('.editable-marks').value);
      const updates = {
        Marks: marks,
        Grade: calculateGrade(marks),
        Status: getStatus(marks),
        "Exam Name": row.querySelector('.exam-name-select')?.value || ''
      };

      row.querySelector('.grade-select').value = updates.Grade;
      row.querySelector('.status-select').value = updates.Status;

      const res = await updateStudent(className, rollNo, updates);
      alert(res.message || (res.success ? 'Saved!' : 'Failed to save'));
    }
  </script>
</body>
</html>
