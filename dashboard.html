<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CFEA Teacher Dashboard</title>
  <style>
    :root {
      --primary: #4a6fa5;
      --secondary: #166088;
      --accent: #4fc3f7;
      --error: #f44336;
      --success: #4caf50;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    
    header {
      background-color: var(--primary);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .logout-btn {
      background-color: var(--secondary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .logout-btn:hover {
      background-color: #0d4b6e;
    }
    
    main {
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .class-section {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      overflow: hidden;
    }
    
    .class-header {
      background-color: var(--secondary);
      color: white;
      padding: 1rem;
      margin: 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }
    
    .editable {
      background-color: #fff8e1;
    }
    
    input[type="number"] {
      width: 60px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    select {
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
    }
    
    .save-btn {
      background-color: var(--success);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .save-btn:hover {
      background-color: #3d8b40;
    }
    
    .save-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error-message {
      color: var(--error);
      padding: 1rem;
      background-color: #ffebee;
      border-radius: 4px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>CFEA Teacher Dashboard</h1>
    <div>
      <span id="teacher-email" style="margin-right: 1rem;"></span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>
  
  <main id="dashboard-container">
    <div id="loading-indicator" style="text-align: center; padding: 2rem;">
      <div class="loading"></div>
      <p>Loading your classes...</p>
    </div>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxcZuaBkiWNaphNEz1cBbFk2zOw5ci5vU4R9iHbIvbrG7ZAWujk3tY9YIIO0fCUI9vz/exec";
    let authToken = localStorage.getItem('authToken');
    
    // Check authentication
    if (!authToken) {
      window.location.href = 'index.html';
    }
    
    // Parse JWT token to get user info
    function parseJwt(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch (e) {
        return null;
      }
    }
    
    const userInfo = parseJwt(authToken);
    if (!userInfo || userInfo.exp < Date.now()) {
      localStorage.removeItem('authToken');
      window.location.href = 'index.html';
    }
    
    document.getElementById('teacher-email').textContent = userInfo.email;
    
    async function fetchWithAuth(url, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      };
      
      const response = await fetch(url, {
        ...options,
        headers: {
          ...headers,
          ...options.headers
        }
      });
      
      if (response.status === 401) {
        logout();
        return;
      }
      
      return response;
    }
    
    function logout() {
      localStorage.removeItem('authToken');
      window.location.href = 'index.html';
    }
    
    async function loadClassData() {
      try {
        const response = await fetchWithAuth(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            type: 'getAllowedClasses'
          })
        });
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'Failed to load classes');
        }
        
        renderDashboard(data.allowedClasses);
      } catch (error) {
        document.getElementById('loading-indicator').innerHTML = `
          <div class="error-message">
            <strong>Error:</strong> ${error.message}
          </div>
          <button onclick="window.location.reload()">Retry</button>
        `;
      }
    }
    
    async function renderDashboard(classes) {
      const container = document.getElementById('dashboard-container');
      container.innerHTML = '';
      
      if (classes.length === 0) {
        container.innerHTML = `
          <div class="error-message">
            No classes assigned to your account.
          </div>
        `;
        return;
      }
      
      for (const className of classes) {
        const section = document.createElement('div');
        section.className = 'class-section';
        section.innerHTML = `
          <h2 class="class-header">${className}</h2>
          <div id="class-${className.replace(/\s+/g, '-')}" class="class-content">
            <p style="padding: 1rem; text-align: center;">
              <div class="loading"></div> Loading students...
            </p>
          </div>
        `;
        container.appendChild(section);
        
        loadClassStudents(className);
      }
    }
    
    async function loadClassStudents(className) {
      try {
        const response = await fetchWithAuth(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            type: 'getClassData',
            className: className
          })
        });
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || `Failed to load ${className} data`);
        }
        
        renderClassTable(className, data.headers, data.students);
      } catch (error) {
        document.getElementById(`class-${className.replace(/\s+/g, '-')}`).innerHTML = `
          <div class="error-message">
            <strong>Error loading ${className}:</strong> ${error.message}
          </div>
        `;
      }
    }
    
    function renderClassTable(className, headers, students) {
      const container = document.getElementById(`class-${className.replace(/\s+/g, '-')}`);
      
      if (students.length === 0) {
        container.innerHTML = '<p style="padding: 1rem;">No students found in this class.</p>';
        return;
      }
      
      const table = document.createElement('table');
      
      // Create table header
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      
      headerRow.appendChild(document.createElement('th')); // Actions column
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement('tbody');
      
      students.forEach(student => {
        const row = document.createElement('tr');
        
        headers.forEach(header => {
          const td = document.createElement('td');
          
          if (header === 'Marks') {
            td.innerHTML = `
              <input type="number" 
                     value="${student[header] || ''}" 
                     min="0" max="100"
                     onchange="updateGrade(this, '${student['Roll No'] || student['roll no']}')"
                     class="marks-input">
            `;
            td.classList.add('editable');
          } 
          else if (header === 'Grade') {
            td.innerHTML = `
              <select class="grade-select" disabled>
                <option value="A+" ${student[header] === 'A+' ? 'selected' : ''}>A+</option>
                <option value="A" ${student[header] === 'A' ? 'selected' : ''}>A</option>
                <option value="B" ${student[header] === 'B' ? 'selected' : ''}>B</option>
                <option value="C" ${student[header] === 'C' ? 'selected' : ''}>C</option>
                <option value="D" ${student[header] === 'D' ? 'selected' : ''}>D</option>
                <option value="F" ${student[header] === 'F' ? 'selected' : ''}>F</option>
              </select>
            `;
          }
          else if (header === 'Status' || header === 'Result') {
            td.innerHTML = `
              <select class="status-select" disabled>
                <option value="Pass" ${student[header] === 'Pass' ? 'selected' : ''}>Pass</option>
                <option value="Fail" ${student[header] === 'Fail' ? 'selected' : ''}>Fail</option>
                <option value="Pending" ${!student[header] || student[header] === 'Pending' ? 'selected' : ''}>Pending</option>
              </select>
            `;
          }
          else {
            td.textContent = student[header] || '-';
          }
          
          row.appendChild(td);
        });
        
        // Add save button
        const actionTd = document.createElement('td');
        actionTd.innerHTML = `
          <button class="save-btn" 
                  onclick="saveStudent('${className}', '${student['Roll No'] || student['roll no']}')"
                  disabled>
            Save
          </button>
        `;
        row.appendChild(actionTd);
        
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }
    
    function updateGrade(inputElement, rollNo) {
      const marks = parseFloat(inputElement.value);
      const row = inputElement.closest('tr');
      
      if (!isNaN(marks)) {
        // Update grade
        const gradeSelect = row.querySelector('.grade-select');
        gradeSelect.value = calculateGrade(marks);
        
        // Update status
        const statusSelect = row.querySelector('.status-select');
        statusSelect.value = marks >= 35 ? 'Pass' : 'Fail';
        
        // Enable save button
        row.querySelector('.save-btn').disabled = false;
      }
    }
    
    function calculateGrade(marks) {
      if (marks >= 90) return 'A+';
      if (marks >= 80) return 'A';
      if (marks >= 70) return 'B';
      if (marks >= 60) return 'C';
      if (marks >= 50) return 'D';
      return 'F';
    }
    
    async function saveStudent(className, rollNo) {
      const row = document.querySelector(`tr:has(.marks-input[value][onchange*="${rollNo}"])`);
      if (!row) return;
      
      const saveBtn = row.querySelector('.save-btn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<div class="loading" style="margin: 0 auto;"></div>';
      
      try {
        const marksInput = row.querySelector('.marks-input');
        const gradeSelect = row.querySelector('.grade-select');
        const statusSelect = row.querySelector('.status-select');
        
        const updates = {
          Marks: marksInput.value !== '' ? parseFloat(marksInput.value) : null,
          Grade: gradeSelect.value,
          Status: statusSelect.value
        };
        
        const response = await fetchWithAuth(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            type: 'update',
            className,
            rollNo,
            updates
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          saveBtn.textContent = 'Saved!';
          setTimeout(() => {
            saveBtn.textContent = 'Save';
            saveBtn.disabled = true;
          }, 2000);
        } else {
          throw new Error(result.message || 'Failed to save');
        }
      } catch (error) {
        saveBtn.textContent = 'Error';
        saveBtn.style.backgroundColor = 'var(--error)';
        alert(`Error: ${error.message}`);
        
        setTimeout(() => {
          saveBtn.textContent = 'Save';
          saveBtn.style.backgroundColor = 'var(--success)';
        }, 2000);
      }
    }
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', loadClassData);
  </script>
</body>
</html>
